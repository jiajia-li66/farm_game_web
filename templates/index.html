<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç§ç”°å…»æˆæ¸¸æˆæ•°æ®åº“</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> <!-- âœ… æ›¿ä»£ FontAwesome -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background: url("/static/R.jpg") no-repeat center center fixed;
            background-size: cover;
            font-family: "Segoe UI", sans-serif;
            animation: fadeIn 1s ease-in-out;
        }
        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        .card {
            background-color: rgba(255, 255, 255, 0.93);
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border-left: 6px solid #ffc107;
        }
        .card-header {
            font-weight: bold;
            font-size: 1.25rem;
        }
    </style>
</head>

<body>
<div class="container py-4">
    <h1 class="text-center text-white mb-4">ğŸŒ¾ ç§ç”°å…»æˆæ¸¸æˆæ•°æ®åº“</h1>

    <!-- ç¤ºä¾‹æ¨¡å—ï¼šç©å®¶ -->
    <div class="card mb-4 p-3 border-success">
        <div class="card-header bg-success text-white">ğŸ‘¤ ç©å®¶ç®¡ç†</div>
        <form id="player-form" class="row g-3" method="POST" action="/add_item">
            <div class="col-auto">
                <input class="form-control" name="gold" type="number" placeholder="åˆå§‹é‡‘å¸" required>
            </div>
            <div class="col-auto">
                <button class="btn btn-success" type="submit">æ·»åŠ ç©å®¶</button>
            </div>
        </form>

        <div class="mt-3 mb-2 d-flex">
            <input class="form-control me-2" id="player-search" placeholder="æœç´¢PlayerID..." style="max-width: 200px;">
            <button class="btn btn-outline-dark" onclick="loadPlayers()">æœç´¢</button>
        </div>

    <ul id="player-list" class="mt-3 list-unstyled"></ul>
    <nav>
        <ul id="pagination" class="pagination pagination-sm"></ul>
    </nav>
</div>

    <!-- ç¤ºä¾‹æ¨¡å—ï¼šç‰©å“ -->
    <div class="card mb-4 p-3 border-primary">
        <div class="card-header bg-primary text-white">ğŸ“¦ ç‰©å“ç®¡ç†</div>
        <form id="item-form" class="row g-3" method="POST" action="/add_item">
            <div class="col-md-3"><input class="form-control" name="item_name" placeholder="åç§°" required></div>
            <div class="col-md-3"><input class="form-control" name="category" placeholder="ç±»åˆ«" required></div>
            <div class="col-md-4"><input class="form-control" name="description" placeholder="æè¿°"></div>
            <div class="col-md-2"><button class="btn btn-primary" type="submit">æ·»åŠ ç‰©å“</button></div>
        </form>
        <ul class="mt-3">
            {% for i in items %}
            <li>{{ i.ItemName }}ï¼ˆ{{ i.Category }}ï¼‰ï¼š{{ i.Description }}
    <a href="#" class="text-primary ms-2" onclick="showEditForm('item', {{ i.ItemID }}, { ItemName: '{{ i.ItemName }}', Category: '{{ i.Category }}', Description: '{{ i.Description }}' })"><i class="fas fa-edit"></i></a>
    <a href="#" class="text-danger ms-2" onclick="deleteEntry('item', {{ i.ItemID }})"><i class="fas fa-trash"></i></a>
</li>
            {% endfor %}
        </ul>
    </div>

    <!-- ç¤ºä¾‹æ¨¡å—ï¼šæ¤ç‰© -->
    <div class="card mb-4 p-3 border-warning">
        <div class="card-header bg-warning text-dark">ğŸŒ± æ¤ç‰©ç®¡ç†</div>
        <form id="plant-form" method="POST" action="/add_plant">
            <div class="col-md-3"><input class="form-control" name="plant_name" placeholder="åç§°" required></div>
            <div class="col-md-2"><input class="form-control" name="growth_time" type="number" placeholder="æˆç†Ÿæ—¶é—´" required></div>
            <div class="col-md-2"><input class="form-control" name="water_effect" type="number" placeholder="æµ‡æ°´æ•ˆæœ" required></div>
            <div class="col-md-2"><input class="form-control" name="max_water" type="number" placeholder="æœ€å¤§æµ‡æ°´" required></div>
            <div class="col-md-2"><input class="form-control" name="seed_price" type="number" placeholder="ç§å­ä»·æ ¼" required></div>
            <div class="col-md-2"><input class="form-control" name="sell_price" type="number" placeholder="å”®ä»·" required></div>
            <div class="col-md-2"><input class="form-control" name="yield" type="number" placeholder="æ”¶è·é‡" required></div>
            <div class="col-md-2"><button class="btn btn-warning" type="submit">æ·»åŠ æ¤ç‰©</button></div>
        </form>
    <ul class="mt-3">
      {% for plant in plants %}
      <li>
        {{ plant.PlantName }}ï¼šæˆé•¿ {{ plant.BaseGrowthTime }} åˆ†é’Ÿï¼Œ
        æµ‡æ°´æ•ˆæœï¼š{{ plant.WaterEffectPerTime }}ï¼Œ
        æœ€å¤§æµ‡æ°´ï¼š{{ plant.MaxWaterTimes }} æ¬¡ï¼Œ
        ç§å­ä»·æ ¼ï¼š{{ plant.SeedPrice }}ï¼Œ
        å”®ä»·ï¼š{{ plant.SellPrice }}ï¼Œ
        æ”¶è·é‡ï¼š{{ plant.HarvestYield }}
        <a href="#" class="text-primary ms-2" onclick="showEditForm('plant', {{ plant.PlantID }}, {
          PlantName: '{{ plant.PlantName }}',
          BaseGrowthTime: {{ plant.BaseGrowthTime }},
          WaterEffectPerTime: {{ plant.WaterEffectPerTime }},
          MaxWaterTimes: {{ plant.MaxWaterTimes }},
          SeedPrice: {{ plant.SeedPrice }},
          SellPrice: {{ plant.SellPrice }},
          HarvestYield: {{ plant.HarvestYield }}
        })"><i class="fas fa-edit"></i></a>
        <a href="#" class="text-danger ms-2" onclick="deleteEntry('plant', {{ plant.PlantID }})"><i class="fas fa-trash"></i></a>
      </li>
      {% endfor %}
    </ul>
    </div>


    <!-- è®¢å•æ¨¡å— -->
    <div class="card mb-4 p-3 border-dark">
        <div class="card-header bg-dark text-white">ğŸ“‹ è®¢å•ç®¡ç†</div>
        <form id="order-form" class="row g-3" method="POST" action="/add_item">
            <div class="col-md-2"><input class="form-control" name="villager_id" placeholder="æ‘æ°‘ID" required></div>
            <div class="col-md-2"><input class="form-control" name="item_id" placeholder="ç‰©å“ID" required></div>
            <div class="col-md-2"><input class="form-control" name="quantity" placeholder="æ•°é‡" required></div>
            <div class="col-md-2"><input class="form-control" name="reward" placeholder="é‡‘å¸å¥–åŠ±" required></div>
            <div class="col-md-2"><input class="form-control" name="affection" placeholder="å¥½æ„Ÿå¥–åŠ±" required></div>
            <div class="col-md-2"><button class="btn btn-secondary" type="submit">æ·»åŠ è®¢å•</button></div>
        </form>
        <ul class="mt-3">
            {% for o in orders %}
            <li>è®¢å• {{ o.OrderID }} - æ‘æ°‘{{ o.VillagerID }} è¦ {{ o.RequiredQuantity }} Ã— {{ o.RequiredItemID }}ï¼Œå¥–åŠ± {{ o.RewardGold }} é‡‘å¸
    <span class="badge bg-info">{{ o.Status }}</span>
    <a href="/complete_order/{{ o.OrderID }}" class="text-success ms-2">å®Œæˆ</a>
    <a href="#" class="text-primary ms-2" onclick="showEditForm('order', {{ o.OrderID }}, {
        VillagerID: {{ o.VillagerID }},
        RequiredItemID: {{ o.RequiredItemID }},
        RequiredQuantity: {{ o.RequiredQuantity }},
        RewardGold: {{ o.RewardGold }},
        RewardAffection: {{ o.RewardAffection }},
        Status: '{{ o.Status }}'
    })"><i class="fas fa-edit"></i></a>
    <a href="#" class="text-danger ms-2" onclick="deleteEntry('order', {{ o.OrderID }})"><i class="fas fa-trash"></i></a>
</li>
            {% endfor %}
        </ul>
    </div>

    <!-- ä»“åº“æ¨¡å— -->
    <div class="card mb-4 p-3 border-info">
        <div class="card-header bg-info text-white">ğŸ“¦ ä»“åº“ç®¡ç†</div>
        <form id="inventory-form" class="row g-3" method="POST" action="/add_item">
            <div class="col-md-3"><input class="form-control" name="player_id" placeholder="ç©å®¶ID" required></div>
            <div class="col-md-3"><input class="form-control" name="item_id" placeholder="ç‰©å“ID" required></div>
            <div class="col-md-3"><input class="form-control" name="quantity" placeholder="æ•°é‡" required></div>
            <div class="col-md-3"><button class="btn btn-info" type="submit">æ·»åŠ åˆ°ä»“åº“</button></div>
        </form>
        <ul class="mt-3">
            {% for inv in inventory %}
            <li>ç©å®¶{{ inv.PlayerID }}ï¼šç‰©å“{{ inv.ItemID }} Ã— {{ inv.Quantity }}
    <a href="#" class="text-primary ms-2" onclick="showEditForm('inventory', '{{ inv.PlayerID }}_{{ inv.ItemID }}', { Quantity: {{ inv.Quantity }} })"><i class="fas fa-edit"></i></a>
    <a href="#" class="text-danger ms-2" onclick="deleteEntry('inventory', '{{ inv.PlayerID }}_{{ inv.ItemID }}')"><i class="fas fa-trash"></i></a>
</li>
            {% endfor %}
        </ul>
    </div>

    <!-- å•†åº—æ¨¡å— -->
    <div class="card mb-4 p-3 border-danger">
        <div class="card-header bg-danger text-white">ğŸª å•†åº—ç®¡ç†</div>
        <form id="shop-form" class="row g-2" method="POST" action="/add_shopitem">
          <div class="col-md-6">
            <select class="form-control" name="item_id" required>
              <option value="">è¯·é€‰æ‹©ç‰©å“</option>
              {% for item in items %}
                <option value="{{ item.ItemID }}">{{ item.ItemName }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <input class="form-control" name="sell_price" placeholder="å”®ä»·" required>
          </div>
          <div class="col-md-2">
            <button class="btn btn-danger" type="submit">ä¸Šæ¶å•†å“</button>
          </div>
        </form>
        <ul class="mt-3">
            {% for s in shop_items %}
            <li>ç‰©å“{{ s.ItemID }}ï¼šå”®ä»· {{ s.SellPrice }} é‡‘å¸
    <a href="#" class="text-primary ms-2" onclick="showEditForm('shopitem', {{ s.ItemID }}, { SellPrice: {{ s.SellPrice }} })"><i class="fas fa-edit"></i></a>
    <a href="#" class="text-danger ms-2" onclick="deleteEntry('shopitem', {{ s.ItemID }})"><i class="fas fa-trash"></i></a>
</li>
            {% endfor %}
        </ul>
    </div>

    <!-- æ‘æ°‘æ¨¡å— -->
    <div class="card mb-4 p-3 border-secondary">
        <div class="card-header bg-secondary text-white">ğŸ§‘ æ‘æ°‘ç®¡ç†</div>
        <form id="villager-form" class="row g-2" method="POST" action="/add_villager">
          <div class="col-md-6">
            <input class="form-control" name="name" placeholder="å§“å" required>
          </div>
          <div class="col-md-4">
            <select class="form-control" name="gender" required>
              <option value="">é€‰æ‹©æ€§åˆ«</option>
              <option value="ç”·">ç”·</option>
              <option value="å¥³">å¥³</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary" type="submit">æ·»åŠ æ‘æ°‘</button>
          </div>
        </form>
        <ul class="mt-3">
            {% for v in villagers %}
            <li>{{ v.Name }}ï¼ˆ{{ v.Gender }}ï¼‰
    <a href="#" class="text-primary ms-2" onclick="showEditForm('villager', {{ v.VillagerID }}, { Name: '{{ v.Name }}', Gender: '{{ v.Gender }}' })"><i class="fas fa-edit"></i></a>
    <a href="#" class="text-danger ms-2" onclick="deleteEntry('villager', {{ v.VillagerID }})"><i class="fas fa-trash"></i></a>
</li>
            {% endfor %}
        </ul>
    </div>

    <!-- åœ°å—å±•ç¤º -->
    <div class="card mb-4 p-3 border-light">
        <div class="card-header bg-light">ğŸŒ¾ åœ°å—å±•ç¤º</div>
        <div class="row row-cols-4 g-3">
            {% for plot in plots %}
            <div class="col">
                <div class="border rounded p-2 text-center" style="background-color: {% if plot.Status == 'Empty' %}#f8f9fa{% elif plot.Status == 'Growing' %}#e0ffe0{% elif plot.Status == 'Harvestable' %}#fff3cd{% else %}#dee2e6{% endif %};">
                    <div class="fw-bold">åœ°å— {{ plot.PlotID }}</div>
                    ç©å®¶ï¼š{{ plot.PlayerID }}<br>
                    çŠ¶æ€ï¼š{{ plot.Status }}<br>
                    æ¤ç‰©ï¼š{{ plot.PlantedPlantID or 'æ— ' }}
                    <a href="#" class="text-primary d-block mt-1" onclick="showEditForm('plot', {{ plot.PlotID }}, {
    PlayerID: {{ plot.PlayerID }},
    Status: '{{ plot.Status }}',
    PlantedPlantID: {{ plot.PlantedPlantID or 'null' }}
})">ç¼–è¾‘</a>
<a href="#" class="text-danger d-block" onclick="deleteEntry('plot', {{ plot.PlotID }})">åˆ é™¤</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- é€šç”¨ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">ä¿®æ”¹æ•°æ®</h5></div>
    <div class="modal-body">
      <form id="edit-form"></form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="submitEditForm()">ä¿å­˜ä¿®æ”¹</button>
    </div>
  </div></div>
</div>

<script>
let currentEditType = '', currentEditId = '';

function deleteEntry(type, id) {
    if (!confirm("ç¡®è®¤åˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ")) return;
    fetch(`/delete_${type}/${id}`).then(() => location.reload());
}

function showEditForm(type, id, fields) {
    currentEditType = type;
    currentEditId = id;
    const form = document.getElementById('edit-form');
    form.innerHTML = '';
    for (const key in fields) {
        form.innerHTML += `<div class="mb-3">
            <label class="form-label">${key}</label>
            <input class="form-control" name="${key}" value="${fields[key]}" required>
        </div>`;
    }
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

function submitEditForm() {
    const form = document.getElementById('edit-form');
    const data = {};
    new FormData(form).forEach((value, key) => data[key] = value);
    fetch(`/update_${currentEditType}/${currentEditId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(res => res.ok ? location.reload() : alert('ä¿®æ”¹å¤±è´¥'));
}

function setupFormValidation(formId, requiredNames) {
    const form = document.getElementById(formId);
    if (!form) return;
    form.addEventListener("submit", function(e) {
        for (const name of requiredNames) {
            const input = this.querySelector(`[name='${name}']`);
            if (input && !input.value.trim()) {
                e.preventDefault();
                alert(`è¯·è¾“å…¥ ${name} å­—æ®µ`);
                return;
            }
        }
    });
}

document.addEventListener("DOMContentLoaded", () => {
    setupFormValidation("order-form", ["villager_id", "item_id", "quantity", "reward", "affection"]);
    setupFormValidation("inventory-form", ["player_id", "item_id", "quantity"]);
    setupFormValidation("shop-form", ["item_id", "sell_price"]);
    setupFormValidation("villager-form", ["name", "gender"]);
});

document.addEventListener("DOMContentLoaded", () => {
    loadPlayers();
    setupFormValidation("player-form", ["gold"]);
});

document.getElementById("player-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('/add_player', {
        method: 'POST',
        body: formData
    }).then(() => {
        this.reset();
        loadPlayers(currentPage);
    });
});

function loadPlayers(page = 1) {
    currentPage = page;
    const query = document.getElementById("player-search").value;
    fetch(`/api/players?page=${page}&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            const list = document.getElementById("player-list");
            list.innerHTML = '';
            for (const p of data.players) {
                list.innerHTML += `<li>ID: ${p.PlayerID}, é‡‘å¸: ${p.CurrentGold}
                    <a href="#" class="text-primary ms-2" onclick="showEditForm('player', ${p.PlayerID}, { gold: ${p.CurrentGold} })"><i class="fas fa-edit"></i></a>
                    <a href="#" class="text-danger ms-2" onclick="deleteEntry('player', ${p.PlayerID})"><i class="fas fa-trash"></i></a>
                </li>`;
            }

            const pagination = document.getElementById("pagination");
            const totalPages = Math.ceil(data.total / 5);
            pagination.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                pagination.innerHTML += `<li class="page-item ${i === page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadPlayers(${i})">${i}</a>
                </li>`;
            }
        });
}

</script>
</body>
</html>
